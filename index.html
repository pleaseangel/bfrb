<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BFRB Urge Simulator</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <!-- Authentication Check Overlay -->
  <div id="authLoader" class="auth-overlay">
    <div class="auth-card">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
  </div>

  <!-- Main App Content -->
  <div id="appContent" style="display: none;">
    <!-- User Info Bar -->
    <div class="user-bar">
      <div class="user-info">
        <span>Welcome, <strong id="userName">User</strong></span>
        <span class="tier-badge" id="userTier">Free Plan</span>
      </div>
      <div class="user-actions">
        <span id="sessionsRemaining">3 sessions remaining today</span>
        <button id="upgradeBtn" class="upgrade-btn">Upgrade</button>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>

    <!-- Session Limit Warning -->
    <div id="sessionLimitWarning" class="session-warning" style="display: none;">
      <div class="warning-card">
        <h3>Daily Session Limit Reached</h3>
        <p>You've used all your sessions for today. Upgrade to continue practicing!</p>
        <button onclick="window.location.href='subscription.html'" class="upgrade-cta">Upgrade Now</button>
      </div>
    </div>

    <!-- Toast Messages -->
    <div class="toast" id="toast">Message</div>

    <!-- Header with KPIs and Controls -->
    <header>
      <div class="kpi">
        <div>Session <b id="clock">03:00</b></div>
        <div>Resist pts <b id="resist">0</b></div>
        <div>Trap hits <b id="hits">0</b></div>
        <div>Pull attempts <b id="pulls">0</b></div>
        <div>Streak days <b id="streak">0</b></div>
      </div>
      <div class="controls">
        <button id="startBtn">Start</button>
        <button id="resetBtn" class="secondary">Reset</button>
        <button id="breatheBtn" class="ghost">Breathing 60s</button>
        <button id="trainerBtn" class="ghost">Trainer mode</button>
        <button id="soundBtn" class="ghost">Sound: OFF</button>
        <button id="customBtn" class="ghost">Customize</button>
      </div>
    </header>

    <!-- Main Content -->
    <div class="wrap">
      <!-- Hair Patch Simulator -->
      <div id="patch" class="card">
        <div class="overlay" id="overlay">
          <div class="card" style="text-align:center; min-width:300px;">
            <div style="font-weight:700; margin-bottom:6px; color:var(--warn)">Pause</div>
            <div class="category-tag" id="categoryTag">Physical</div>
            <div class="muted" style="max-width:340px;" id="pauseMessage">Squeeze your fists tight and hold</div>
            <div class="countdown" id="countdown">8</div>
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="card" style="margin-top:14px">
        <b>How to use</b>
        <ol class="muted">
          <li>Tap or drag on the hair patch if you feel an urge.</li>
          <li>If a <i>trap hair</i> triggers, pause and follow the competing response guidance.</li>
          <li>Earn resist points by letting the timer run without triggering traps.</li>
        </ol>
      </div>

      <!-- Customization Panel -->
      <div class="card custom-responses" id="customPanel" style="margin-top:14px; display:none;">
        <b>Customize Competing Responses</b>
        <div style="margin-top:12px;">
          <select id="categorySelect" style="padding:6px; border:1px solid #e5e7eb; border-radius:6px;">
            <option value="physical">Physical</option>
            <option value="breathing">Breathing</option>
            <option value="cognitive">Cognitive</option>
          </select>
          <input type="text" id="customInput" class="custom-input" placeholder="Add your own competing response...">
          <button id="addCustomBtn" style="margin-top:8px;">Add Response</button>
        </div>
        <div class="response-list" id="responseList"></div>
      </div>

      <!-- Premium Features Notice -->
      <div class="card premium-notice" id="premiumNotice" style="margin-top:14px; display:none;">
        <div class="premium-content">
          <h3>ðŸŒŸ Premium Features Available</h3>
          <ul>
            <li>Detailed progress analytics and charts</li>
            <li>Advanced customization options</li>
            <li>Export session data</li>
            <li>Priority customer support</li>
          </ul>
          <button onclick="window.location.href='subscription.html'" class="upgrade-cta">Upgrade to unlock</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div>Wellness companion. Not medical advice.</div>
      <div class="footer-links">
        <a href="dashboard.html" id="dashboardLink" style="display:none;">Dashboard</a>
        <a href="subscription.html">Manage Subscription</a>
      </div>
    </footer>
  </div>

  <!-- Firebase SDKs - Using JSDelivr CDN as backup -->
  <script src="https://cdn.jsdelivr.net/npm/firebase@8.10.1/firebase-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@8.10.1/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@8.10.1/firebase-firestore.js"></script>
  
  <!-- App Scripts -->
  <script>
    // Wait for Firebase to load, then initialize
    function initializeApp() {
      if (typeof firebase === 'undefined') {
        console.log('Firebase not loaded yet, retrying...');
        setTimeout(initializeApp, 500);
        return;
      }

      console.log('Firebase loaded successfully');

      // Your Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyAwGE1f6n_oRq-pdDy2nuvR_EuDTCNaeG4",
        authDomain: "mybfrb-a89f9.firebaseapp.com",
        projectId: "mybfrb-a89f9",
        storageBucket: "mybfrb-a89f9.firebasestorage.app",
        messagingSenderId: "226276330728",
        appId: "1:226276330728:web:46ddadded7502f15ee4d5d"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      console.log('Firebase initialized');

      // Check authentication
      firebase.auth().onAuthStateChanged(function(user) {
        console.log('Auth state changed:', user ? user.email : 'No user');
        
        const authLoader = document.getElementById('authLoader');
        const appContent = document.getElementById('appContent');
        
        if (user) {
          // User is signed in - show app
          authLoader.style.display = 'none';
          appContent.style.display = 'block';
          
          // Update user name
          const userName = document.getElementById('userName');
          if (userName) {
            userName.textContent = user.displayName || user.email.split('@')[0] || 'User';
          }
          
        } else {
          // Not signed in - go to login
          console.log('No user, redirecting to login');
          window.location.href = 'login.html';
        }
      });

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          console.log('Logging out...');
          firebase.auth().signOut();
        });
      }

      // Initialize BFRB Simulator
      initializeBFRBSimulator();
    }

    // Complete BFRB Simulator Code
    function initializeBFRBSimulator() {
      console.log('Initializing BFRB Simulator...');
      
      // Utility functions
      const $ = (s) => document.querySelector(s);
      const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
      const vibrate = (ms) => { 
        try { if (navigator.vibrate) navigator.vibrate(ms); } catch(_){} 
      };

      // Simulator state
      const DURATION_SEC = 180;
      const HAIR_COUNT = 96;
      const TRAP_RATIO = 0.22;

      let running = false;
      let tLeft = DURATION_SEC;
      let timer = null;
      let resistPts = 0;
      let trapHits = 0;
      let pullAttempts = 0;
      let lastActionTs = Date.now();
      let trainerMode = false;
      let soundEnabled = false;
      let reshuffleTimer = null;
      let countdownTimer = null;

      // Competing responses
      const competingResponses = {
        physical: [
          "Squeeze your fists tight and hold",
          "Clasp hands behind your back firmly", 
          "Press palms together at chest level",
          "Grip chair armrests or table edge",
          "Cross arms and squeeze shoulders"
        ],
        breathing: [
          "Take 5 slow, deep belly breaths",
          "Breathe in for 4, hold 4, out for 6",
          "Focus on exhaling twice as long as inhaling", 
          "Take 3 deep breaths through your nose",
          "Breathe deeply and relax jaw & shoulders"
        ],
        cognitive: [
          "Count backwards from 20 slowly",
          "Name 5 things you can see around you",
          "Repeat 'I choose to pause' 3 times",
          "Think of your favorite peaceful place", 
          "List 3 things you're grateful for today"
        ]
      };

      // Sound functions
      function createClick() {
        if (!soundEnabled) return;
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.frequency.value = 400; gain.gain.value = 0.05;
          osc.start(); 
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
          osc.stop(ctx.currentTime + 0.1);
        } catch(_){}
      }

      function createBeep(freq, duration) {
        if (!soundEnabled) return;
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.frequency.value = freq; gain.gain.value = 0.1;
          osc.start();
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration/1000);
          osc.stop(ctx.currentTime + duration/1000);
        } catch(_){}
      }

      // Update HUD
      function updateHUD() {
        const m = Math.floor(tLeft / 60);
        const ss = String(tLeft % 60).padStart(2, '0');
        $('#clock').textContent = `${String(m).padStart(2, '0')}:${ss}`;
        $('#resist').textContent = resistPts;
        $('#hits').textContent = trapHits;
        $('#pulls').textContent = pullAttempts;
      }

      // Build hair patch
      function buildPatch(reshuffleOnly = false) {
        const patch = $('#patch');
        if (!reshuffleOnly) {
          patch.querySelectorAll('.hair').forEach(n => n.remove());
        }
        
        const w = patch.clientWidth;
        const h = patch.clientHeight;
        const count = HAIR_COUNT;
        const trapCount = Math.max(1, Math.floor(count * TRAP_RATIO));
        const trapIdx = new Set();
        
        while (trapIdx.size < trapCount) {
          trapIdx.add(rand(0, count - 1));
        }

        const hairs = patch.querySelectorAll('.hair');
        
        for (let i = 0; i < count; i++) {
          let hair;
          
          if (reshuffleOnly && hairs[i]) {
            hair = hairs[i];
            hair.classList.remove('trap', 'safe');
            hair.style.boxShadow = '';
          } else {
            hair = document.createElement('div');
            const x = rand(18, w - 18);
            const y = rand(Math.floor(h * 0.40), Math.floor(h * 0.86));
            const len = rand(48, 96);
            
            hair.style.left = x + 'px';
            hair.style.top = (y - len) + 'px';
            hair.style.height = len + 'px';
            hair.style.transform = `rotate(${rand(-10, 10)}deg)`;
          }
          
          hair.className = 'hair ' + (trapIdx.has(i) ? 'trap' : 'safe');
          
          if (trainerMode && hair.classList.contains('trap')) { 
            hair.style.boxShadow = '0 0 0 2px rgba(239,68,68,0.25)'; 
          }

          if (!reshuffleOnly) {
            const hit = (e) => {
              if (!running) return;
              e.preventDefault();
              
              hair.classList.add('hit');
              pullAttempts++;
              lastActionTs = Date.now();
              updateHUD();
              
              createClick();
              
              if (hair.classList.contains('trap')) {
                triggerTrap();
              }
              
              setTimeout(() => hair.classList.remove('hit'), 120);
            };
            
            hair.addEventListener('mousedown', hit);
            hair.addEventListener('touchstart', hit, {passive: false});
            patch.appendChild(hair);
          }
        }
      }

      // Trigger trap
      function triggerTrap() {
        trapHits++;
        updateHUD();
        vibrate([0, 50, 40, 50]);
        createBeep(800, 200);
        
        const categories = Object.keys(competingResponses);
        const category = categories[rand(0, categories.length - 1)];
        const responses = competingResponses[category];
        const response = responses[rand(0, responses.length - 1)];
        
        $('#categoryTag').textContent = category.charAt(0).toUpperCase() + category.slice(1);
        $('#pauseMessage').textContent = response;
        
        const overlay = $('#overlay'); 
        overlay.classList.add('show');
        
        let count = 8;
        $('#countdown').textContent = count;
        countdownTimer = setInterval(() => {
          count--;
          $('#countdown').textContent = count;
          if (count <= 0) {
            clearInterval(countdownTimer);
            overlay.classList.remove('show');
          }
        }, 1000);
        
        showToast('Pause + follow the competing response');
      }

      // Show toast
      function showToast(message) {
        const toast = $('#toast');
        if (toast) {
          toast.textContent = message;
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 3000);
        }
      }

      // Session management
      function start() {
        if (running) return;
        
        running = true;
        tick();
        timer = setInterval(tick, 1000);
        reshuffleTimer = setInterval(() => { 
          if (running) buildPatch(true); 
        }, 20000);
        
        showToast('Session started');
      }

      function reset() {
        running = false;
        clearInterval(timer);
        clearInterval(reshuffleTimer);
        clearInterval(countdownTimer);
        
        tLeft = DURATION_SEC;
        resistPts = 0;
        trapHits = 0;
        pullAttempts = 0;
        
        updateHUD();
        buildPatch();
        showToast('Session reset');
      }

      function tick() {
        if (!running) return;
        
        tLeft--;
        if (tLeft <= 0) {
          complete();
          return;
        }
        
        const idle = (Date.now() - lastActionTs) / 1000;
        if (idle >= 10) {
          resistPts++;
          lastActionTs = Date.now();
          updateHUD();
        }
        
        updateHUD();
      }

      function complete() {
        running = false;
        clearInterval(timer);
        clearInterval(reshuffleTimer);
        clearInterval(countdownTimer);
        
        const success = trapHits === 0;
        if (success) {
          showToast('ðŸŽ‰ Perfect session! No trap hits.');
          vibrate(60);
        } else {
          showToast('Session complete. Keep practicing!');
        }
        
        tLeft = DURATION_SEC;
      }

      function breathing60() {
        let secs = 60;
        const breatheBtn = $('#breatheBtn');
        const originalText = breatheBtn.textContent;
        
        const id = setInterval(() => {
          secs--;
          breatheBtn.textContent = `Breathing ${secs}s`;
          if (secs <= 0) {
            clearInterval(id);
            breatheBtn.textContent = originalText;
            showToast('Breathing exercise complete!');
          }
        }, 1000);
      }

      // Event listeners
      $('#startBtn').addEventListener('click', start);
      $('#resetBtn').addEventListener('click', reset);
      $('#breatheBtn').addEventListener('click', breathing60);
      
      $('#trainerBtn').addEventListener('click', () => {
        trainerMode = !trainerMode;
        $('#trainerBtn').textContent = trainerMode ? 'Trainer mode: ON' : 'Trainer mode';
        buildPatch();
        showToast(trainerMode ? 'Trainer mode enabled' : 'Trainer mode disabled');
      });
      
      $('#soundBtn').addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        $('#soundBtn').textContent = soundEnabled ? 'Sound: ON' : 'Sound: OFF';
        showToast(soundEnabled ? 'Sound enabled' : 'Sound disabled');
      });

      // Initialize the simulator
      setTimeout(() => {
        buildPatch();
        updateHUD();
        console.log('BFRB Simulator initialized successfully');
      }, 500);
    }

    // Start initialization when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
